<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TactileSQL Loading</title>
    <link rel="stylesheet" href="splashscreen.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Outfit:wght@500;700&display=swap"
        rel="stylesheet">
</head>

<body>
    <div class="background-grid">
        <div class="grid-overlay"></div>
    </div>

    <div class="splash-content">
        <div class="brand-section">
            <div class="logo-wrapper">
                <img src="/logo-tr.png" alt="TactileSQL Logo" class="logo">
                <div class="logo-glow"></div>
            </div>
            <div class="title-wrapper">
                <h1 class="app-name">TactileSQL</h1>
                <div class="version-badge">v0.1.0</div>
            </div>
        </div>

        <p class="tagline">Initializing Secure Environment</p>

        <div class="loader-container">
            <div class="scan-line"></div>
            <div class="progress-track">
                <div class="progress-bar"></div>
            </div>
            <div class="loading-status">
                <span id="status-text">Loading modules...</span>
                <span class="percentage">0%</span>
            </div>
        </div>

        <button id="close-btn" class="fallback-close">
            <span>Force Start</span>
        </button>
    </div>

    <script>
        const { invoke } = window.__TAURI__.core;

        // Simulated loading progress
        function simulateProgress() {
            const bar = document.querySelector('.progress-bar');
            const pct = document.querySelector('.percentage');
            const status = document.getElementById('status-text');
            const steps = [
                { width: '20%', text: 'Loading core modules...' },
                { width: '45%', text: 'Initializing database drivers...' },
                { width: '70%', text: 'Verifying secure connections...' },
                { width: '90%', text: 'Starting workbench...' },
                { width: '100%', text: 'Ready' }
            ];

            let step = 0;
            const interval = setInterval(() => {
                if (step >= steps.length) {
                    clearInterval(interval);
                    return;
                }

                const s = steps[step];
                bar.style.width = s.width;
                if (pct) pct.innerText = s.width; // Just show percentage text
                if (status) status.innerText = s.text;

                step++;
            }, 300);
        }

        async function initTransition() {
            simulateProgress();

            try {
                // Wait for animation
                await new Promise(resolve => setTimeout(resolve, 2500));
                // Call Rust command to handle windows
                await invoke('close_splashscreen');
            } catch (e) {
                console.error("Invoke failed", e);
                // Last ditch effort
                try {
                    const { getCurrentWindow } = window.__TAURI__.window;
                    await getCurrentWindow().close();
                } catch (err) {
                    console.error("Failed to close window", err);
                }
            }
        }

        // Show fallback close button if taking too long
        setTimeout(() => {
            const btn = document.getElementById('close-btn');
            if (btn) btn.style.display = 'flex';
        }, 6000);

        // Start logic
        initTransition();

        document.getElementById('close-btn').onclick = async () => {
            await invoke('close_splashscreen');
        };
    </script>
</body>

</html>